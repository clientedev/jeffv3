<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atribuir Empresas - Núcleo 1.03</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Atribuir Empresas a Consultores</h1>
            <a href="/dashboard" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Voltar</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">Selecionar Consultor</h2>
                <select id="consultorSelect" class="w-full p-2 bg-gray-700 rounded mb-4">
                    <option value="">Carregando...</option>
                </select>

                <div class="mb-4">
                    <input type="text" id="searchEmpresa" placeholder="Buscar empresa..." 
                           class="w-full p-2 bg-gray-700 rounded">
                </div>

                <div id="empresasList" class="space-y-2 max-h-96 overflow-y-auto">
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">Empresas Atribuídas</h2>
                <div id="empresasAtribuidas" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-400">Selecione um consultor para ver suas empresas</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        let consultores = [];
        let empresas = [];
        let consultorSelecionado = null;

        async function carregarConsultores() {
            try {
                const response = await apiRequest('/api/usuarios');
                consultores = response.filter(u => u.tipo === 'consultor');
                
                const select = document.getElementById('consultorSelect');
                select.innerHTML = '<option value="">Selecione um consultor</option>';
                consultores.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });
            } catch (error) {
                console.error('Erro ao carregar consultores:', error);
            }
        }

        async function carregarEmpresas() {
            try {
                const response = await apiRequest('/api/empresas');
                empresas = response;
                renderizarEmpresas();
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
            }
        }

        function renderizarEmpresas(filtro = '') {
            const lista = document.getElementById('empresasList');
            const empresasFiltradas = empresas.filter(e => 
                e.empresa.toLowerCase().includes(filtro.toLowerCase()) ||
                (e.cnpj && e.cnpj.includes(filtro))
            );

            lista.innerHTML = '';
            empresasFiltradas.forEach(empresa => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <div class="font-semibold">${empresa.empresa}</div>
                        <div class="text-sm text-gray-400">${empresa.cnpj || 'N/A'}</div>
                    </div>
                    <button onclick="atribuirEmpresa(${empresa.id})" 
                            class="bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-500">
                        Atribuir
                    </button>
                `;
                lista.appendChild(div);
            });
        }

        async function atribuirEmpresa(empresaId) {
            if (!consultorSelecionado) {
                alert('Selecione um consultor primeiro');
                return;
            }

            try {
                await apiRequest('/api/atribuicoes/', 'POST', {
                    consultor_id: consultorSelecionado,
                    empresa_id: empresaId,
                    ativa: true
                });
                
                await carregarEmpresasAtribuidas();
            } catch (error) {
                alert('Erro ao atribuir empresa: ' + error.message);
            }
        }

        async function carregarEmpresasAtribuidas() {
            if (!consultorSelecionado) return;

            try {
                const response = await apiRequest(`/api/atribuicoes/consultor/${consultorSelecionado}`);
                const div = document.getElementById('empresasAtribuidas');
                
                if (response.length === 0) {
                    div.innerHTML = '<p class="text-gray-400">Nenhuma empresa atribuída</p>';
                    return;
                }

                div.innerHTML = '';
                for (const atr of response) {
                    const empresaResp = await apiRequest(`/api/empresas/${atr.empresa_id}`);
                    const empresaDiv = document.createElement('div');
                    empresaDiv.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    empresaDiv.innerHTML = `
                        <div>
                            <div class="font-semibold">${empresaResp.empresa}</div>
                            <div class="text-sm text-gray-400">${empresaResp.cnpj || 'N/A'}</div>
                        </div>
                        <button onclick="removerAtribuicao(${atr.id})" 
                                class="bg-red-600 px-3 py-1 rounded text-sm hover:bg-red-500">
                            Remover
                        </button>
                    `;
                    div.appendChild(empresaDiv);
                }
            } catch (error) {
                console.error('Erro ao carregar empresas atribuídas:', error);
            }
        }

        async function removerAtribuicao(atribuicaoId) {
            if (!confirm('Deseja realmente remover esta atribuição?')) return;

            try {
                await apiRequest(`/api/atribuicoes/${atribuicaoId}`, 'DELETE');
                await carregarEmpresasAtribuidas();
            } catch (error) {
                alert('Erro ao remover atribuição: ' + error.message);
            }
        }

        document.getElementById('consultorSelect').addEventListener('change', (e) => {
            consultorSelecionado = e.target.value ? parseInt(e.target.value) : null;
            carregarEmpresasAtribuidas();
        });

        document.getElementById('searchEmpresa').addEventListener('input', (e) => {
            renderizarEmpresas(e.target.value);
        });

        carregarConsultores();
        carregarEmpresas();
    </script>
</body>
</html>
